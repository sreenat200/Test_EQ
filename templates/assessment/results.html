{% extends 'base.html' %}

{% block extra_head %}
<style>
    .container {
        max-width: 1200px !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <div style="text-align: center; margin-bottom: 3rem;">
        <h1 style="font-size: 2.5rem; margin-bottom: 2rem;">{{ interpretation.rating }}</h1>

        <div style="position: relative; width: 150px; height: 150px; margin: 0 auto 1rem;">
            <svg style="width: 100%; height: 100%; transform: rotate(-90deg);">
                <circle cx="75" cy="75" r="70" stroke="rgba(255,255,255,0.1)" stroke-width="10" fill="transparent">
                </circle>
                <circle cx="75" cy="75" r="70" stroke="#3b82f6" stroke-width="10" fill="transparent"
                    stroke-dasharray="440" stroke-dashoffset="{{ dash_offset }}"></circle>
                <!-- Simplified math for dashoffset: 2 * PI * R (approx 440). Offset = 440 - (440 * score / 100) -->
            </svg>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <span style="font-size: 2.5rem; font-weight: bold; color: white;">{{ formatted_overall_score }}</span>
                <span style="display: block; font-size: 0.8rem; color: var(--secondary-color);">OVERALL</span>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <div class="glass-container">
            <h3 style="margin-bottom: 1.5rem;">EQ Dimension Breakdown</h3>
            <div style="height: 400px; position: relative;">
                <canvas id="eqChart"></canvas>
            </div>
        </div>

        <div class="glass-container">
            <h3 style="margin-bottom: 1.5rem;">AI Analysis & Feedback</h3>
            <p style="line-height: 1.6; margin-bottom: 1.5rem;">{{ interpretation.feedback }}</p>

            <div style="margin-top: 2rem;">
                <h4 style="margin-bottom: 1rem;">Detailed Scores</h4>
                {% for category, score in scores.items %}
                {% if category != 'Overall' %}
                <div class="score-card">
                    <span>{{ category }}</span>
                    <span
                        style="font-weight: bold; color: {% if score >= 80 %}#4ade80{% elif score >= 60 %}#fbbf24{% else %}#f87171{% endif %}">
                        {{ score }}
                    </span>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <div style="text-align: center;">
        <a href="{% url 'index' %}" class="btn-primary" style="text-decoration: none; display: inline-block;">Retake
            Assessment</a>
    </div>
</div>

<script>
    const ctx = document.getElementById('eqChart').getContext('2d');
    const scores = {{ scores| safe }};

    // Remove 'Overall' from chart data
    const labels = Object.keys(scores).filter(k => k !== 'Overall');
    const data = labels.map(k => scores[k]);

    // Color mapping to match text score colors
    // >= 80: #4ade80 (Green)
    // >= 60: #fbbf24 (Yellow)
    // < 60:  #f87171 (Red)
    const backgroundColors = data.map(score => {
        if (score >= 80) return 'rgba(74, 222, 128, 0.7)';
        if (score >= 60) return 'rgba(251, 191, 36, 0.7)';
        return 'rgba(248, 113, 113, 0.7)';
    });

    const borderColors = data.map(score => {
        if (score >= 80) return '#4ade80';
        if (score >= 60) return '#fbbf24';
        return '#f87171';
    });

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'EQ Score',
                data: data,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1,
                borderRadius: 4,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#cbd5e1'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#cbd5e1'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
</script>
{% endblock %}